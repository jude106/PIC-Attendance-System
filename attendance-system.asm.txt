#INCLUDE "P16F877A.INC"

REG1	EQU	0X20
REG2	EQU	0X21
REG3	EQU	0X22
REG4    EQU 0X23
COUNTER	EQU	0X24
CURSOR_POS EQU 0x25
REG6 EQU 0X27
REG5 EQU 0X26
__CONFIG _CP_OFF & _WDT_OFF & _PWRTE_OFF & _BODEN_OFF & _LVP_OFF & _HS_OSC

	
ORG	0X00

CONFI BSF STATUS,RP0  ;BSF H'03',5  BANK1
      MOVLW H'FF' 
      MOVWF TRISB   ; PORTB INPUT 
          
      MOVLW H'00'
      MOVWF TRISD   ; PORTD OUTPUT
      
      MOVLW H'07'    ; PORTA ANALOG ; PORTE DIGITAL 
      MOVWF ADCON1   ; 
      
      MOVLW H'00'
	  MOVWF TRISE

	  MOVLW D'25'         ; 9600 baud rate
      MOVWF SPBRG
    
      BCF TXSTA,SYNC      ; Asynchronous mode
      BSF TXSTA,BRGH      ; High speed baud rate
      BSF TXSTA,TXEN      ; Enable transmitter

      BCF STATUS,RP0  ; BANK0

	  BSF RCSTA,SPEN
	  BSF RCSTA,CREN

INIT  CLRF PORTD
      
      CALL CONFILCD 
      
; THIS IS OUR LOOP
 
MAIN1 MOVLW H'80'
	  MOVWF REG4

MAIN MOVLW H'86'
	 SUBWF REG4,W
	 BTFSC STATUS,Z
	 GOTO SEND_DATA
	 BTFSS PORTB,4
	 GOTO MAIN 
	 CALL WAIT_RELEASE  
	 MOVF PORTB,W
 	 ANDLW H'0F'
     
                  
LOOP     GOTO TABLE    
     	 GOTO MAIN 

TABLE ADDWF PCL,F   
      GOTO DISPLAY_D ; ASSOCIATED VALUE OF D
	  GOTO DISPLAY_#  ; ASSOCIATED VALUE OF#
      GOTO DISPLAY_0  ; ....OF  0
      GOTO DISPLAY_STAR  ; ....OF  *
	  GOTO DISPLAY_C  ; ....OF  C
	  GOTO DISPLAY_9  ; ....OF  9
      GOTO DISPLAY_8  ; ....OF  8
	  GOTO DISPLAY_7  ; ....OF  7
      GOTO DISPLAY_B  ; ....OF  B
      GOTO DISPLAY_6  ; ....OF  6
      GOTO DISPLAY_5  ; ....OF  5
      GOTO DISPLAY_4  ; ....OF  4
      GOTO DISPLAY_A  ; ....OF  A
      GOTO DISPLAY_3  ; ....OF  3 
      GOTO DISPLAY_2  ; ....OF  2 
      GOTO DISPLAY_1  ; ....OF  1 

DISPLAY_D MOVF REG4,W
		  CALL COMMAND
		  MOVLW A'D'
		  CALL CHAR
	      MOVLW 'D'
	      CALL SEND_CHAR
		  INCF REG4
		  GOTO MAIN

DISPLAY_# MOVF REG4,W
		  CALL COMMAND
		  MOVLW A'#'
		  CALL CHAR
		  MOVLW A'#'
	      CALL SEND_CHAR
		  INCF REG4
		  GOTO MAIN

DISPLAY_0 MOVF REG4,W
		  CALL COMMAND
		  MOVLW A'0'
		  CALL CHAR
		  MOVLW A'0'
	      CALL SEND_CHAR
	      INCF REG4
		  GOTO MAIN

DISPLAY_STAR MOVF REG4,W
		  CALL COMMAND
		  MOVLW A'*'
		  CALL CHAR
	      MOVLW A'*'
	      CALL SEND_CHAR
		  INCF REG4
		  GOTO MAIN

DISPLAY_C MOVF REG4,W
		  CALL COMMAND
		  MOVLW A'C'
		  CALL CHAR
	      MOVLW A'C'
		  CALL SEND_CHAR
		  INCF REG4
		  GOTO MAIN

DISPLAY_9 MOVF REG4,W
		  CALL COMMAND
		  MOVLW A'9'
		  CALL CHAR
	      MOVLW A'9'
	      CALL SEND_CHAR
		  INCF REG4
		  GOTO MAIN

DISPLAY_8 MOVF REG4,W
		  CALL COMMAND
		  MOVLW A'8'
		  CALL CHAR
	      MOVLW A'8'
	      CALL SEND_CHAR
		  INCF REG4
		  GOTO MAIN

DISPLAY_7 MOVF REG4,W
		  CALL COMMAND
		  MOVLW A'7'
		  CALL CHAR
	      MOVLW A'7'
	      CALL SEND_CHAR
		  INCF REG4
		  GOTO MAIN

DISPLAY_B MOVF REG4,W
		  CALL COMMAND
		  MOVLW A'B'
		  CALL CHAR
	      MOVLW A'B'
	      CALL SEND_CHAR
		  INCF REG4
		  GOTO MAIN

DISPLAY_6 MOVF REG4,W
		  CALL COMMAND
		  MOVLW A'6'
		  CALL CHAR
	      MOVLW A'6'
	      CALL SEND_CHAR
		  INCF REG4
		  GOTO MAIN

DISPLAY_5 MOVF REG4,W
		  CALL COMMAND
		  MOVLW A'5'
		  CALL CHAR
	      MOVLW A'5'
		  CALL SEND_CHAR
		  INCF REG4
		  GOTO MAIN

DISPLAY_4 MOVF REG4,W
		  CALL COMMAND
		  MOVLW A'4'
		  CALL CHAR
		  MOVLW A'4'
	      CALL SEND_CHAR
		  INCF REG4
		  GOTO MAIN

DISPLAY_3 MOVF REG4,W
		  CALL COMMAND
		  MOVLW A'3'
		  CALL CHAR
		  MOVLW A'3'
	      CALL SEND_CHAR
		  INCF REG4
		  GOTO MAIN

DISPLAY_2 MOVF REG4,W
		  CALL COMMAND
		  MOVLW A'2'
		  CALL CHAR
		  MOVLW A'2'
	      CALL SEND_CHAR
		  INCF REG4
		  GOTO MAIN

DISPLAY_1 MOVF REG4,W
		  CALL COMMAND
		  MOVLW A'1'
		  CALL CHAR
		  MOVLW A'1'
	      CALL SEND_CHAR
		  INCF REG4
		  GOTO MAIN

DISPLAY_A MOVF REG4,W
		  CALL COMMAND
		  MOVLW A'A'
		  CALL CHAR
	      MOVLW A'A'
	      CALL SEND_CHAR
		  INCF REG4
		  GOTO MAIN

CONFILCD CALL DELAY20MS
		 MOVLW H'3C'
		 CALL COMMAND
		 MOVLW H'0C'
		 CALL COMMAND
		 MOVLW H'06'
		 CALL COMMAND
		 MOVLW H'01'
		 CALL COMMAND
		 RETURN 

COMMAND BCF PORTE,2 ; RS=0 
        BCF PORTE,0 ; E= 0
		MOVWF PORTD  ; SENDING THE BYTE TO THE DATA PORT OF LCD 
		NOP          ; SHORT DELAY 1 CYCLE 
		BSF PORTE,0  ;E= 1
		NOP          ; DELAY OF THE ENABLE PULSE
		BCF PORTE,0  ; E= 0 
		CALL DELAY3MS ; TIME OF EXECUTION 
		RETURN

CHAR    BSF PORTE,2  ; RS= 1
        BCF PORTE,0
		MOVWF PORTD
		NOP
		BSF PORTE,0
		NOP
		BCF PORTE,0
		CALL DELAY3MS
		RETURN

RESET_LCD CALL LCD_CLEAR
		  MOVLW H'80'
		  MOVWF REG4
		  GOTO MAIN
SEND_DATA CALL LCD_CLEAR
	      MOVLW H'80'
		  MOVWF REG4
	      BCF RCSTA,CREN      ; Disable receiver
    	  MOVF RCREG,W        ; Dummy read to clear buffer
    	  BSF RCSTA,CREN      ; Re-enable receiver
		  GOTO RECEIVE_DATA

RECEIVE_DATA 
BTFSS PIR1,RCIF
    GOTO RECEIVE_DATA
    
    ; Read data
    MOVF RCREG,W
    
    ; If it's '1', turn on LED at D1
    XORLW '1'
    BTFSC STATUS,Z
    GOTO ACCESS_GRANTED
    
    MOVF RCREG,W
    XORLW '0'
    BTFSC STATUS,Z
    GOTO ACCESS_DENIED
	
	MOVF RCREG,W
    XORLW '2'
    BTFSC STATUS,Z
    GOTO LATE
    
    GOTO RECEIVE_DATA

 
ACCESS_GRANTED CALL LCD_CLEAR
		MOVLW H'83'
	   CALL COMMAND
	   MOVLW A'A'   
       CALL CHAR
       MOVLW A'C'   
       CALL CHAR
       MOVLW A'C'
       CALL CHAR
	   MOVLW A'E'
	   CALL CHAR
       MOVLW A'S'
       CALL CHAR
	   MOVLW A'S'
       CALL CHAR
       MOVLW H'C3'
       CALL COMMAND
       MOVLW A'G'
       CALL CHAR
       MOVLW A'R'
       CALL CHAR
       MOVLW A'A'
       CALL CHAR
	   MOVLW A'N'
       CALL CHAR
	   MOVLW A'T'
       CALL CHAR
	   MOVLW A'E'
       CALL CHAR
	   MOVLW A'D'
       CALL CHAR
	   CALL DELAY10S
	   CALL LCD_CLEAR
	   GOTO OPEN_LOCK
OPEN_LOCK CALL LCD_CLEAR
		MOVLW H'85'
	   CALL COMMAND
	   MOVLW A'L'   
       CALL CHAR
       MOVLW A'O'   
       CALL CHAR
       MOVLW A'C'
       CALL CHAR
	   MOVLW A'K'
	   CALL CHAR
       MOVLW H'C4'
       CALL COMMAND
       MOVLW A'O'
       CALL CHAR
       MOVLW A'P'
       CALL CHAR
       MOVLW A'E'
       CALL CHAR
	   MOVLW A'N'
       CALL CHAR
	   CALL DELAY10S
	   CALL LCD_CLEAR
	   GOTO MAIN1
	   
ACCESS_DENIED CALL LCD_CLEAR
		MOVLW H'83'
	   CALL COMMAND
	   MOVLW A'A'  
       CALL CHAR
       MOVLW A'C'   
       CALL CHAR
       MOVLW A'C'
       CALL CHAR
	   MOVLW A'E'
	   CALL CHAR
       MOVLW A'S'
       CALL CHAR
	   MOVLW A'S'
       CALL CHAR
       MOVLW H'C3'
       CALL COMMAND
       MOVLW A'D'
       CALL CHAR
       MOVLW A'E'
       CALL CHAR
       MOVLW A'N'
       CALL CHAR
	   MOVLW A'I'
       CALL CHAR
	   MOVLW A'E'
       CALL CHAR
	   MOVLW A'D'
       CALL CHAR
	   CALL DELAY10S
	   CALL LCD_CLEAR
	   MOVLW H'0A'
	   MOVWF REG6
	   GOTO OPEN_DOOR
	   GOTO MAIN
OPEN_DOOR BTFSC PORTB,5
		  GOTO RELEASE_BUTTON
		  CALL DELAY500MS
		  DECF REG6
		  MOVLW H'00'
		  SUBWF REG6,W
		  BTFSS STATUS,Z
		  GOTO OPEN_DOOR
		  GOTO MAIN

RELEASE_BUTTON
		CALL DELAY500MS
WAIT_BUTTON BTFSC PORTB,5
		GOTO WAIT_RELEASE
		GOTO OPEN_LOCK
		  
LATE CALL LCD_CLEAR
		MOVLW H'83'
	   CALL COMMAND
	   MOVLW A'L'  
       CALL CHAR
       MOVLW A'A'   
       CALL CHAR
       MOVLW A'T'
       CALL CHAR
	   MOVLW A'E'
	   CALL CHAR
	   CALL DELAY10S
	   CALL LCD_CLEAR
	   GOTO OPEN_LOCK

LCD_CLEAR
    MOVLW 0x01  ; CLEAR SCREEN 
    CALL COMMAND
    CALL DELAY20MS
    CLRF CURSOR_POS
    MOVLW 0x80  ; Move to line 1, position 0
    CALL COMMAND
    RETURN

WAIT_RELEASE BTFSC PORTB,4
	         GOTO WAIT_RELEASE
			 RETURN


SEND_CHAR
    MOVWF TXREG         ; Load data into transmit register
WAIT_TX
    BSF STATUS,RP0
    BTFSS TXSTA,TRMT    ; Wait until transmission complete
    GOTO WAIT_TX
    BCF STATUS,RP0
    RETURN

DELAY20MS 
        MOVLW D'1'
        MOVWF REG3
        MOVLW D'25'
        MOVWF REG2
        MOVLW D'255'
		MOVWF REG1
        DECFSZ REG1,F
		GOTO $-1
		DECFSZ REG2,F
		GOTO $-5
		DECFSZ REG3,F
		GOTO $-9
        RETURN 

DELAY500MS 
        MOVLW D'5'
        MOVWF REG3
        MOVLW D'122'
        MOVWF REG2
        MOVLW D'255'
		MOVWF REG1
        DECFSZ REG1,F
		GOTO $-1
		DECFSZ REG2,F
		GOTO $-5
		DECFSZ REG3,F
		GOTO $-9
        RETURN 

DELAY10S 
        MOVLW D'20'
        MOVWF REG3
        MOVLW D'255'
        MOVWF REG2
        MOVLW D'255'
		MOVWF REG1
        DECFSZ REG1,F
		GOTO $-1
		DECFSZ REG2,F
		GOTO $-5
		DECFSZ REG3,F
		GOTO $-9
        RETURN 

DELAY3MS 
        MOVLW D'1'
        MOVWF REG3
        MOVLW D'6'
        MOVWF REG2
        MOVLW D'166'
		MOVWF REG1
        DECFSZ REG1,F
		GOTO $-1
		DECFSZ REG2,F
		GOTO $-5
		DECFSZ REG3,F
		GOTO $-9
        RETURN 


      END